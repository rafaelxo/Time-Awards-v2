<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TimeAwards - Login de Usuário</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="login.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
    </style>
</head>

<body>
    <div id="particles-js"></div>
    <div id="notification-container"></div>
    <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-body"></div>
    </div>

    <div id="login">
        <div class="container">
            <div id="login-row" class="row justify-content-center align-items-center">
                <div id="login-column" class="col-lg-5 col-md-7 col-sm-9">
                    <div id="login-box">
                        <div class="login-header">
                            <a href="/dashboard.html" class="brand-link">
                                <svg width="56" height="56" viewBox="0 0 24 24" fill="none"
                                    xmlns="http://www.w3.org/2000/svg" class="logo-icone">
                                    <circle cx="12" cy="12" r="10" stroke="#4285F4" stroke-width="2" />
                                    <path d="M12 6V12L16 16" stroke="#4285F4" stroke-width="2" stroke-linecap="round" />
                                </svg>
                                <h1 class="logo-texto">TimeAwards</h1>
                            </a>

                            <div id="auto-login-message" class="auto-login-message" style="display: none;">
                                <i class="bi bi-info-circle"></i>
                                <span id="auto-login-text">Redirecionando...</span>
                                <button type="button" class="btn-cancel-auto-login" onclick="cancelAutoLogin()">
                                    <i class="bi bi-x-circle"></i> Usar outra conta
                                </button>
                            </div>
                        </div>

                        <div class="divider"></div>

                        <form id="login-form" class="form" method="post">
                            <div class="form-group">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-person"></i></span>
                                    <input type="text" name="username" id="username" class="form-control"
                                        placeholder=" " required>
                                    <label for="username" class="form-label">Login</label>
                                    <i class="bi validation-icon"></i>
                                </div>
                                <span id="login-error" class="error-message"></span>
                            </div>

                            <div class="form-group password-toggle">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-lock"></i></span>
                                    <input type="password" name="password" id="password" class="form-control"
                                        placeholder=" " required>
                                    <label for="password" class="form-label">Senha</label>
                                    <i class="bi bi-eye-slash password-toggle-icon" id="togglePassword"></i>
                                    <i class="bi validation-icon"></i>
                                </div>
                                <span id="password-error" class="error-message"></span>
                            </div>

                            <div class="login-options">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="rememberMe" name="rememberMe">
                                    <label class="form-check-label" for="rememberMe">
                                        <i class="bi bi-shield-check"></i> Manter conectado
                                    </label>
                                </div>
                                <div class="forgot-password">
                                    <a href="#!"><i class="bi bi-key"></i> Esqueci minha senha</a>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary btn-block" data-bs-toggle="tooltip"
                                title="Acesse sua conta">
                                <i class="bi bi-box-arrow-in-right"></i> Entrar
                            </button>

                            <div class="divider-text">
                                <span>ou</span>
                            </div>

                            <button type="button" class="btn btn-outline-secondary btn-block" data-bs-toggle="modal"
                                data-bs-target="#registerModal" data-bs-toggle="tooltip" title="Crie uma nova conta">
                                <i class="bi bi-person-plus"></i> Criar nova conta
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-header-content">
                        <i class="bi bi-person-plus-fill modal-icon"></i>
                        <div>
                            <h5 class="modal-title" id="registerModalLabel">Criar Nova Conta</h5>
                            <p class="modal-subtitle">Preencha os campos abaixo para se registrar</p>
                        </div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="register-form" class="form">
                        <div class="form-section">
                            <h6 class="section-title">
                                <i class="bi bi-person-badge"></i> Informações Pessoais
                            </h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="bi bi-person"></i></span>
                                            <input type="text" name="txt_nome" id="txt_nome" class="form-control"
                                                placeholder=" " required data-bs-toggle="tooltip"
                                                title="Digite seu nome completo">
                                            <label for="txt_nome" class="form-label">Nome completo</label>
                                            <i class="bi validation-icon"></i>
                                        </div>
                                        <span id="txt_nome-error" class="error-message"></span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                                            <input type="email" name="txt_email" id="txt_email" class="form-control"
                                                placeholder=" " required data-bs-toggle="tooltip"
                                                title="Use um email válido">
                                            <label for="txt_email" class="form-label">Email</label>
                                            <i class="bi validation-icon"></i>
                                        </div>
                                        <span id="txt_email-error" class="error-message"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-telephone"></i></span>
                                    <input type="tel" name="txt_telefone" id="txt_telefone" class="form-control"
                                        placeholder=" " required data-bs-toggle="tooltip" title="Digite seu telefone">
                                    <label for="txt_telefone" class="form-label">Telefone</label>
                                    <i class="bi validation-icon"></i>
                                </div>
                                <span id="txt_telefone-error" class="error-message"></span>
                            </div>
                        </div>

                        <div class="section-divider"></div>

                        <div class="form-section">
                            <h6 class="section-title">
                                <i class="bi bi-shield-lock"></i> Credenciais de Acesso
                            </h6>
                            <div class="form-group">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-person-circle"></i></span>
                                    <input type="text" name="txt_login" id="txt_login" class="form-control"
                                        placeholder=" " required data-bs-toggle="tooltip"
                                        title="Mínimo de 5 caracteres">
                                    <label for="txt_login" class="form-label">Nome de Usuário</label>
                                    <i class="bi validation-icon"></i>
                                </div>
                                <span id="txt_login-error" class="error-message"></span>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group password-toggle">
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="bi bi-lock"></i></span>
                                            <input type="password" name="txt_senha" id="txt_senha" class="form-control"
                                                placeholder=" " required data-bs-toggle="tooltip"
                                                title="Mínimo de 8 caracteres com letras, números e símbolos">
                                            <label for="txt_senha" class="form-label">Senha</label>
                                            <i class="bi bi-eye-slash password-toggle-icon" id="toggleSenha"></i>
                                            <i class="bi validation-icon"></i>
                                        </div>
                                        <span id="txt_senha-error" class="error-message"></span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group password-toggle">
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="bi bi-lock-fill"></i></span>
                                            <input type="password" name="txt_senha2" id="txt_senha2"
                                                class="form-control" placeholder=" " required data-bs-toggle="tooltip"
                                                title="Confirme sua senha">
                                            <label for="txt_senha2" class="form-label">Confirmar Senha</label>
                                            <i class="bi bi-eye-slash password-toggle-icon" id="toggleSenha2"></i>
                                            <i class="bi validation-icon"></i>
                                        </div>
                                        <span id="txt_senha2-error" class="error-message"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="password-requirements">
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i> A senha deve conter: mínimo 8 caracteres, letras
                                maiúsculas e minúsculas, números e símbolos (!@#$%^&*)
                            </small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="button" id="btn_salvar" class="btn btn-success">
                        <i class="bi bi-check-circle"></i> Criar Conta
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script src="login.js"></script>
    <script>
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));

        function setupPasswordToggle(inputId, toggleId) {
            const input = document.getElementById(inputId);
            const toggle = document.getElementById(toggleId);
            toggle.addEventListener('click', () => {
                const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                input.setAttribute('type', type);
                toggle.classList.toggle('bi-eye');
                toggle.classList.toggle('bi-eye-slash');
            });
        }

        setupPasswordToggle('password', 'togglePassword');
        setupPasswordToggle('txt_senha', 'toggleSenha');
        setupPasswordToggle('txt_senha2', 'toggleSenha2');

        function validateField(input, icon) {
            const value = input.value.trim();
            let isValid = false;

            if (input.id === 'username' || input.id === 'txt_login') {
                isValid = value.length >= 5 && value.length <= 50 && /^[a-zA-Z0-9_]+$/.test(value);
            } else if (input.id === 'password' || input.id === 'txt_senha') {
                isValid = value.length >= 8 &&
                    value.length <= 128 &&
                    /[A-Z]/.test(value) &&
                    /[a-z]/.test(value) &&
                    /[0-9]/.test(value) &&
                    /[!@#$%^&*]/.test(value) &&
                    !/\s/.test(value);
            } else if (input.id === 'txt_senha2') {
                const senha = document.getElementById('txt_senha').value.trim();
                isValid = value.length > 0 && value === senha;
            } else if (input.id === 'txt_nome') {
                isValid = value.length >= 3 && value.length <= 100 && /^[a-zA-ZÀ-ÿ\s]+$/.test(value);
            } else if (input.id === 'txt_email') {
                const emailRegex = /^[^\s@]+@[^\s@]+\.(com|net|org|edu|gov|br)$/;
                isValid = emailRegex.test(value.toLowerCase()) && value.length <= 100;
            } else if (input.id === 'txt_telefone') {
                const cleanPhone = value.replace(/[\s\-\(\)]/g, "");
                const phoneRegex = /^\+?[0-9]{10,15}$/;
                isValid = phoneRegex.test(cleanPhone);
            }

            icon.classList.toggle('bi-check-circle-fill', isValid);
            icon.classList.toggle('bi-x-circle-fill', !isValid && value.length > 0);
            icon.classList.toggle('valid', isValid);
            icon.classList.toggle('invalid', !isValid && value.length > 0);
        }

        document.querySelectorAll('.form-control').forEach(input => {
            const icon = input.parentElement.querySelector('.validation-icon');
            if (icon) {
                input.addEventListener('input', () => validateField(input, icon));
                input.addEventListener('blur', () => validateField(input, icon));
            }
        });

        const senhaCadastro = document.getElementById('txt_senha');
        const senha2Cadastro = document.getElementById('txt_senha2');
        if (senhaCadastro && senha2Cadastro) {
            senhaCadastro.addEventListener('input', () => {
                const icon2 = senha2Cadastro.parentElement.querySelector('.validation-icon');
                if (icon2 && senha2Cadastro.value.trim().length > 0) {
                    validateField(senha2Cadastro, icon2);
                }
            });
        }

        particlesJS('particles-js', {
            particles: {
                number: { value: 100, density: { enable: true, value_area: 800 } },
                color: { value: ['#4895ef', '#4361ee', '#3a56d4'] },
                shape: { type: 'circle' },
                opacity: { value: 0.8, random: true },
                size: { value: 4, random: true },
                line_linked: { enable: true, distance: 150, color: '#4895ef', opacity: 0.6, width: 1.5 },
                move: { enable: true, speed: 3, direction: 'none', random: false, straight: false, out_mode: 'out', bounce: false }
            },
            interactivity: {
                detect_on: 'canvas',
                events: { onhover: { enable: true, mode: 'repulse' }, onclick: { enable: true, mode: 'push' }, resize: true },
                modes: { repulse: { distance: 100, duration: 0.4 }, push: { particles_nb: 4 } }
            },
            retina_detect: true
        });

        function showToast(message, type) {
            const toast = document.getElementById('toast');
            const toastBody = toast.querySelector('.toast-body');
            toastBody.textContent = message;
            toast.classList.remove('bg-success', 'bg-danger', 'text-white');
            if (type === 'success') toast.classList.add('bg-success', 'text-white');
            else toast.classList.add('bg-danger', 'text-white');
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }

        function processaFormLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const rememberMe = document.getElementById('rememberMe').checked;
            const loginError = document.getElementById('login-error');
            const senhaError = document.getElementById('password-error');
            const loginButton = document.querySelector('#login-form .btn-primary');

            loginError.textContent = "";
            senhaError.textContent = "";
            loginButton.classList.add('loading');
            loginButton.disabled = true;

            loginUser(username, password, rememberMe).then(resultadoLogin => {
                loginButton.classList.remove('loading');
                loginButton.disabled = false;

                if (resultadoLogin.success) {
                    showToast("Login realizado com sucesso!", 'success');
                    setTimeout(() => {
                        window.location.href = RETURN_URL || "/dashboard.html";
                    }, 500);
                } else {
                    if (resultadoLogin.field === 'login' || resultadoLogin.field === 'username') {
                        loginError.textContent = resultadoLogin.message;
                    } else if (resultadoLogin.field === 'senha' || resultadoLogin.field === 'password') {
                        senhaError.textContent = resultadoLogin.message;
                    } else {
                        showToast(resultadoLogin.message, 'error');
                    }
                }
            }).catch(error => {
                loginButton.classList.remove('loading');
                loginButton.disabled = false;
                showToast('Erro inesperado ao tentar fazer login.', 'error');
                console.error('Erro no login:', error);
            });
        }

        function salvaLogin(event) {
            event.preventDefault();
            const login = document.getElementById('txt_login').value.trim();
            const nome = document.getElementById('txt_nome').value.trim();
            const email = document.getElementById('txt_email').value.trim();
            const telefone = document.getElementById('txt_telefone').value.trim();
            const senha = document.getElementById('txt_senha').value.trim();
            const senha2 = document.getElementById('txt_senha2').value.trim();
            const salvarButton = document.getElementById('btn_salvar');

            document.querySelectorAll('#register-form .error-message').forEach(span => span.textContent = "");
            salvarButton.classList.add('loading');
            salvarButton.disabled = true;

            addUser(nome, login, email, telefone, senha, senha2).then(resultado => {
                salvarButton.classList.remove('loading');
                salvarButton.disabled = false;

                if (resultado.success) {
                    showToast("Usuário registrado com sucesso! Proceda com o login.", 'success');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('registerModal'));
                    if (modal) modal.hide();
                    document.getElementById('register-form').reset();
                    document.querySelectorAll('#register-form .validation-icon').forEach(icon => {
                        icon.classList.remove('bi-check-circle-fill', 'bi-x-circle-fill', 'valid', 'invalid');
                    });
                } else {
                    const fieldMap = {
                        'nome': 'txt_nome',
                        'login': 'txt_login',
                        'email': 'txt_email',
                        'telefone': 'txt_telefone',
                        'senha': 'txt_senha',
                        'senha2': 'txt_senha2'
                    };
                    const errorField = fieldMap[resultado.field] || resultado.field;
                    const errorSpan = document.getElementById(`${errorField}-error`);

                    if (errorSpan) {
                        errorSpan.textContent = resultado.message;
                    } else {
                        showToast(resultado.message, 'error');
                    }
                }
            }).catch(error => {
                salvarButton.classList.remove('loading');
                salvarButton.disabled = false;
                showToast('Erro inesperado ao tentar registrar.', 'error');
                console.error('Erro no registro:', error);
            });
        }

        document.getElementById('login-form').addEventListener('submit', processaFormLogin);
        document.getElementById('btn_salvar').addEventListener('click', salvaLogin);
    </script>
</body>

</html>
